!!!
%html{:lang => "zh-CN"}
  %head
    %meta{:charset => "utf-8"}/
    %meta{:content => "width=device-width, initial-scale=1", :name => "viewport"}/
    %title= "#{@project.name} - 项目详情 - CICD系统"
    %link{:href => "https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css", :rel => "stylesheet"}/
    %link{:href => "https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css", :rel => "stylesheet"}/
    :css
      body {
        font-size: .875rem;
        background-color: #f6f8fa;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
        line-height: 1.5;
        color: #24292e;
      }

      .sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        z-index: 100;
        padding: 56px 0 0;
        background-color: #ffffff;
        transition: all 0.3s ease;
        width: 240px;
        border-right: 1px solid #e1e4e8;
      }

      .sidebar.collapsed {
        width: 60px !important;
      }

      .sidebar.collapsed .sidebar-text {
        display: none;
      }

      .sidebar.collapsed .sidebar-icon {
        margin-right: 0;
      }

      .sidebar-heading {
        font-size: .75rem;
        text-transform: uppercase;
        color: #6c757d;
        padding: 10px 15px;
        font-weight: 600;
      }

      .sidebar-link {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        text-decoration: none;
        color: #24292e;
        transition: all 0.2s;
        font-size: 14px;
      }

      .sidebar-link:hover {
        background-color: #f6f8fa;
        color: #0969da;
      }

      .sidebar-link.active {
        background-color: #f6f8fa;
        color: #0969da;
        font-weight: 600;
      }

      .sidebar-icon {
        margin-right: 12px;
        font-size: 16px;
        width: 16px;
        text-align: center;
      }

      .main-content {
        margin-left: 240px;
        transition: margin-left 0.3s ease;
      }

      .header {
        position: fixed;
        top: 0;
        right: 0;
        left: 240px;
        z-index: 99;
        background-color: #ffffff;
        border-bottom: 1px solid #e1e4e8;
        padding: 8px 16px;
        display: flex;
        align-items: center;
        transition: left 0.3s ease;
      }

      .sidebar-toggle {
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #57606a;
        padding: 4px;
        border-radius: 4px;
      }

      .sidebar-toggle:hover {
        background-color: #f6f8fa;
      }

      .project-header {
        background-color: #ffffff;
        border-bottom: 1px solid #e1e4e8;
        padding: 24px 0;
        margin-top: 56px;
      }

      .repo-name {
        font-weight: 600;
        color: #0969da;
        font-size: 28px;
        text-decoration: none;
      }

      .repo-description {
        color: #57606a;
        font-size: 16px;
        margin-top: 8px;
      }

      .repo-stats {
        color: #57606a;
        font-size: 14px;
      }

      .repo-language-color {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 4px;
      }

      .repo-language-java {
        background-color: #f1e05a;
      }

      .repo-language-javascript {
        background-color: #f1e05a;
      }

      .repo-language-python {
        background-color: #3572A5;
      }

      .repo-language-go {
        background-color: #00ADD8;
      }

      .repo-language-php {
        background-color: #4F5D95;
      }

      .repo-language-dockerfile {
        background-color: #384d54;
      }

      .build-card {
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 16px;
        background-color: #ffffff;
      }

      .build-status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 2em;
        font-size: 12px;
        font-weight: 500;
      }

      .status-success {
        background-color: #dcffe4;
        color: #1a7f37;
      }

      .status-failure {
        background-color: #ffebe9;
        color: #cf222e;
      }

      .status-pending {
        background-color: #ddf4ff;
        color: #0969da;
      }

      .status-running {
        background-color: #ddf4ff;
        color: #0969da;
      }

      .btn-primary {
        background-color: #0969da;
        border-color: #0969da;
      }

      .btn-primary:hover {
        background-color: #0759c4;
        border-color: #0759c4;
      }

      .section-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e1e4e8;
      }

  %body
    .header
      %button#sidebarToggle.sidebar-toggle
        %i.bi.bi-list
      .flex-grow-1
      .dropdown
        %button.btn.btn-sm.btn-outline-secondary.dropdown-toggle{"data-bs-toggle" => "dropdown"}
          %i.bi.bi-person-circle.me-1
          = current_user.username
        .dropdown-menu.dropdown-menu-end
          %a.dropdown-item{:href => "/"}
            %i.bi.bi-speedometer2.me-2
            仪表板
          %a.dropdown-item{:href => "/logout"}
            %i.bi.bi-box-arrow-right.me-2
            退出登录

    .container-fluid
      .row
        %nav#sidebar.sidebar
          .sidebar-sticky
            %ul.nav.flex-column
              %li.nav-item
                %a.nav-link.sidebar-link{:href => "/"}
                  %i.bi.bi-speedometer2.sidebar-icon
                  %span.sidebar-text 仪表板
              %li.nav-item
                %a.nav-link.sidebar-link.active{:href => "/projects"}
                  %i.bi.bi-folder.sidebar-icon
                  %span.sidebar-text 项目管理
              %li.nav-item
                %a.nav-link.sidebar-link{:href => "/builds"}
                  %i.bi.bi-hammer.sidebar-icon
                  %span.sidebar-text 构建管理
              %li.nav-item
                %a.nav-link.sidebar-link{:href => "/resources"}
                  %i.bi.bi-server.sidebar-icon
                  %span.sidebar-text 资源管理
              %li.nav-item
                %a.nav-link.sidebar-link{:href => "/scripts"}
                  %i.bi.bi-file-text.sidebar-icon
                  %span.sidebar-text 脚本管理
              %li.nav-item
                %a.nav-link.sidebar-link{:href => "/plugins"}
                  %i.bi.bi-plug.sidebar-icon
                  %span.sidebar-text 插件管理
              %li.nav-item
                %a.nav-link.sidebar-link{:href => "/system"}
                  %i.bi.bi-gear.sidebar-icon
                  %span.sidebar-text 系统管理

        %main.main-content.col-md-9.ms-sm-auto.col-lg-10.px-md-4
          .project-header
            .container
              .d-flex.justify-content-between.align-items-start
                %div
                  .d-flex.align-items-center
                    %i.bi.bi-folder-fill.text-warning.me-2{:style => "font-size: 32px;"}
                    %h1.repo-name= @project.name
                  .repo-description= @project.respond_to?(:description) ? (@project.description || '暂无描述') : '暂无描述'
                  .mt-2
                    %span.repo-stats
                      %span.repo-language-color{:class => "repo-language-#{@project.respond_to?(:project_type) ? @project.project_type : 'java'}"}
                      = @project.respond_to?(:project_type) ? @project.project_type.capitalize : 'Java'
                    %span.ms-3.repo-stats
                      %i.bi.bi-git.me-1
                      = @project.respond_to?(:branch) ? (@project.branch || 'master') : 'master'
                    %span.ms-3.repo-stats
                      %i.bi.bi-clock.me-1
                      创建于 #{@project.respond_to?(:created_at) && @project.created_at ? @project.created_at.strftime('%Y-%m-%d %H:%M') : '未知时间'}
                .d-flex
                  %a.btn.btn-outline-primary.me-2{:href => "/builds/new?project_id=#{@project.id}"}
                    %i.bi.bi-play-btn.me-1
                    新建构建
                  %a.btn.btn-outline-secondary.me-2{:href => "/projects/#{@project.id}/edit"}
                    %i.bi.bi-gear.me-1
                    设置
                  .dropdown
                    %button.btn.btn-outline-secondary.dropdown-toggle{"data-bs-toggle" => "dropdown"}
                      %i.bi.bi-three-dots
                    .dropdown-menu
                      %a.dropdown-item.delete-project{:href => "#", "data-project-id" => @project.id}
                        %i.bi.bi-trash.me-2
                        删除项目

          .container
            .row
              .col-12
                .section-title 最近构建
                - if @project.respond_to?(:builds_dataset)
                  - @builds = @project.builds_dataset.order(Sequel.desc(:created_at)).limit(10).all
                - else
                  - @builds = []
                  
                - if @builds && !@builds.empty?
                  - @builds.each do |build|
                    .build-card
                      .d-flex.justify-content-between
                        .d-flex.align-items-center
                          .me-3
                            - if build.status == 'success'
                              %i.bi.bi-check-circle-fill.text-success{:style => "font-size: 24px;"}
                            - elsif build.status == 'failed'
                              %i.bi.bi-x-circle-fill.text-danger{:style => "font-size: 24px;"}
                            - else
                              %i.bi.bi-arrow-repeat.text-primary{:style => "font-size: 24px;"}
                          %div
                            .d-flex.align-items-center
                              %strong.me-2
                                构建 ##{build.respond_to?(:build_number) ? (build.build_number || build.id) : build.id}
                              - if build.respond_to?(:branch) && build.branch
                                %span.badge.bg-secondary
                                  = build.branch
                            .text-muted.small
                              %i.bi.bi-hash.me-1
                              = build.respond_to?(:commit_hash) ? (build.commit_hash || '无提交信息') : '无提交信息'
                        .d-flex.align-items-center
                          .build-status{:class => "status-#{build.status}"}
                            = build.status == 'success' ? '成功' : (build.status == 'failed' ? '失败' : (build.status == 'running' ? '运行中' : '等待中'))
                          .ms-3.text-muted.small
                            %i.bi.bi-clock.me-1
                            = build.respond_to?(:created_at) && build.created_at ? build.created_at.strftime('%Y-%m-%d %H:%M') : '未知时间'
                      .mt-2
                        %a.btn.btn-sm.btn-outline-primary{:href => "/builds/#{build.id}"}
                          %i.bi.bi-file-earmark-text.me-1
                          查看日志
                - else
                  .text-center.py-5
                    %i.bi.bi-hammer{:style => "font-size: 48px; color: #d0d7de;"}
                    %p.mt-2 暂无构建记录
                    %a.btn.btn-primary{:href => "/builds/new?project_id=#{@project.id}"}
                      %i.bi.bi-play-btn.me-1
                      创建第一个构建

    %script{:src => "https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"}
    :javascript
      document.addEventListener('DOMContentLoaded', function() {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const mainContent = document.querySelector('.main-content');
        const header = document.querySelector('.header');
        
        // 侧边栏切换
        sidebarToggle.addEventListener('click', function() {
          sidebar.classList.toggle('collapsed');
          if (sidebar.classList.contains('collapsed')) {
            mainContent.style.marginLeft = '60px';
            header.style.left = '60px';
            sidebarToggle.innerHTML = '<i class="bi bi-list"></i>';
          } else {
            mainContent.style.marginLeft = '240px';
            header.style.left = '240px';
            sidebarToggle.innerHTML = '<i class="bi bi-list"></i>';
          }
        });
        
        // 删除项目确认
        document.querySelectorAll('.delete-project').forEach(function(button) {
          button.addEventListener('click', function(e) {
            e.preventDefault();
            const projectId = this.getAttribute('data-project-id');
            if (confirm('确定要删除这个项目吗？此操作不可恢复。')) {
              // 发送删除请求
              fetch('/projects/' + projectId, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                }
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  alert('项目删除成功');
                  window.location.href = '/projects';
                } else {
                  alert('删除失败: ' + data.error);
                }
              })
              .catch(error => {
                alert('删除失败: ' + error.message);
              });
            }
          });
        });
      });