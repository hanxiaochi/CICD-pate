!!!
%html{:lang => "zh-CN"}
  %head
    %meta{:charset => "utf-8"}/
    %meta{:content => "width=device-width, initial-scale=1", :name => "viewport"}/
    %title 脚本管理 - CICD系统
    %link{:href => "https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css", :rel => "stylesheet"}/
    %link{:href => "https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css", :rel => "stylesheet"}/
    :css
      body {
        font-size: .875rem;
        background-color: #f6f8fa;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
        line-height: 1.5;
        color: #24292e;
      }

      .sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        z-index: 100;
        padding: 56px 0 0;
        background-color: #ffffff;
        transition: all 0.3s ease;
        width: 240px;
        border-right: 1px solid #e1e4e8;
      }

      .sidebar.collapsed {
        width: 60px !important;
      }

      .sidebar.collapsed .sidebar-text {
        display: none;
      }

      .sidebar.collapsed .sidebar-icon {
        margin-right: 0;
      }

      .sidebar-heading {
        font-size: .75rem;
        text-transform: uppercase;
        color: #6c757d;
        padding: 10px 15px;
        font-weight: 600;
      }

      .sidebar-link {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        text-decoration: none;
        color: #24292e;
        transition: all 0.2s;
        font-size: 14px;
      }

      .sidebar-link:hover {
        background-color: #f6f8fa;
        color: #0969da;
      }

      .sidebar-link.active {
        background-color: #f6f8fa;
        color: #0969da;
        font-weight: 600;
      }

      .sidebar-icon {
        margin-right: 12px;
        font-size: 16px;
        width: 16px;
        text-align: center;
      }

      .main-content {
        margin-left: 240px;
        transition: margin-left 0.3s ease;
      }

      .header {
        position: fixed;
        top: 0;
        right: 0;
        left: 240px;
        z-index: 99;
        background-color: #ffffff;
        border-bottom: 1px solid #e1e4e8;
        padding: 8px 16px;
        display: flex;
        align-items: center;
        transition: left 0.3s ease;
      }

      .sidebar-toggle {
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #57606a;
        padding: 4px;
        border-radius: 4px;
      }

      .sidebar-toggle:hover {
        background-color: #f6f8fa;
      }

      .script-card {
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.2s;
        margin-bottom: 16px;
        background-color: #ffffff;
      }

      .script-card:hover {
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      }

      .script-name {
        font-weight: 600;
        color: #0969da;
        font-size: 20px;
        text-decoration: none;
      }

      .script-name:hover {
        text-decoration: underline;
      }

      .script-description {
        color: #57606a;
        font-size: 14px;
        margin-bottom: 12px;
      }

      .script-stats {
        color: #57606a;
        font-size: 12px;
      }

      .header-bar {
        background-color: #ffffff;
        border-bottom: 1px solid #e1e4e8;
        padding: 16px 0;
        margin-bottom: 24px;
        margin-top: 56px;
      }

      .btn-primary {
        background-color: #0969da;
        border-color: #0969da;
      }

      .btn-primary:hover {
        background-color: #0759c4;
        border-color: #0759c4;
      }

      .search-box {
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 14px;
        width: 200px;
      }

      .search-box:focus {
        outline: none;
        border-color: #0969da;
        box-shadow: 0 0 0 2px rgba(9, 105, 218, 0.2);
      }

      .no-scripts {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
      }

      .no-scripts i {
        font-size: 48px;
        margin-bottom: 16px;
        color: #d0d7de;
      }

      .no-scripts h3 {
        margin-bottom: 12px;
        font-weight: 500;
      }

  %body
    .header
      %button#sidebarToggle.sidebar-toggle
        %i.bi.bi-list
      .flex-grow-1
      .dropdown
        %button.btn.btn-sm.btn-outline-secondary.dropdown-toggle{"data-bs-toggle" => "dropdown"}
          %i.bi.bi-person-circle.me-1
          = current_user.username
        .dropdown-menu.dropdown-menu-end
          %a.dropdown-item{:href => "/"}
            %i.bi.bi-speedometer2.me-2
            仪表板
          %a.dropdown-item{:href => "/logout"}
            %i.bi.bi-box-arrow-right.me-2
            退出登录

    .container-fluid
      .row
        %nav#sidebar.sidebar
          .sidebar-sticky
            %ul.nav.flex-column
              %li.nav-item
                %a.nav-link.sidebar-link{:href => "/"}
                  %i.bi.bi-speedometer2.sidebar-icon
                  %span.sidebar-text 仪表板
              %li.nav-item
                %a.nav-link.sidebar-link{:href => "/projects"}
                  %i.bi.bi-folder.sidebar-icon
                  %span.sidebar-text 项目管理
              %li.nav-item
                %a.nav-link.sidebar-link{:href => "/builds"}
                  %i.bi.bi-hammer.sidebar-icon
                  %span.sidebar-text 构建管理
              %li.nav-item
                %a.nav-link.sidebar-link{:href => "/resources"}
                  %i.bi.bi-server.sidebar-icon
                  %span.sidebar-text 资源管理
              %li.nav-item
                %a.nav-link.sidebar-link.active{:href => "/scripts"}
                  %i.bi.bi-file-text.sidebar-icon
                  %span.sidebar-text 脚本管理
              %li.nav-item
                %a.nav-link.sidebar-link{:href => "/plugins"}
                  %i.bi.bi-plug.sidebar-icon
                  %span.sidebar-text 插件管理
              %li.nav-item
                %a.nav-link.sidebar-link{:href => "/workspaces"}
                  %i.bi.bi-archive.sidebar-icon
                  %span.sidebar-text 工作空间
              %li.nav-item
                %a.nav-link.sidebar-link{:href => "/system"}
                  %i.bi.bi-gear.sidebar-icon
                  %span.sidebar-text 系统管理

        %main.main-content.col-md-9.ms-sm-auto.col-lg-10.px-md-4
          .header-bar
            .container
              .d-flex.justify-content-between.align-items-center
                %h1.h4.mb-0 脚本
                %button.btn.btn-primary{"data-bs-toggle" => "modal", "data-bs-target" => "#createScriptModal"}
                  %i.bi.bi-plus-lg.me-1
                  新建脚本

          .container
            .row.mb-4
              .col-12
                .d-flex.justify-content-between.align-items-center.mb-3
                  %h2.h5.mb-0 所有脚本
                  .d-flex
                    %input.search-box{:type => "text", :placeholder => "搜索脚本...", :id => "searchInput"}
                    %button.btn.btn-outline-secondary.ms-2{:id => "searchButton"}
                      %i.bi.bi-search

            .row
              .col-12
                - if @scripts && !@scripts.empty?
                  - @scripts.each do |script|
                    .script-card.p-4
                      .d-flex.justify-content-between
                        .d-flex.align-items-center
                          %i.bi.bi-file-text-fill.text-primary.me-2{:style => "font-size: 24px;"}
                          %div
                            %a.script-name{:href => "#"}= script.name
                            .mt-1
                              %span.script-stats
                                %i.bi.bi-code-slash.me-1
                                类型: #{script.script_type || '未知'}
                        .dropdown
                          %button.btn.btn-sm.btn-outline-secondary.dropdown-toggle{"data-bs-toggle" => "dropdown"}
                            %i.bi.bi-three-dots
                          .dropdown-menu
                            %a.dropdown-item{:href => "#"}
                              %i.bi.bi-play-btn.me-2
                              执行
                            %a.dropdown-item{:href => "#"}
                              %i.bi.bi-gear.me-2
                              编辑
                            %a.dropdown-item.delete-script{:href => "#", "data-script-id" => script.id}
                              %i.bi.bi-trash.me-2
                              删除
                      .script-description= script.description || '暂无描述'
                      .d-flex.justify-content-between.align-items-center.mt-3
                        %div
                          %span.script-stats
                            %i.bi.bi-hash.me-1
                            哈希: #{script.content_hash ? script.content_hash[0..10] + '...' : '无'}
                          %span.ms-3.script-stats
                            %i.bi.bi-clock.me-1
                            更新于 #{script.updated_at ? script.updated_at.strftime('%Y-%m-%d %H:%M') : '未知时间'}
                        %button.btn.btn-sm.btn-outline-primary
                          %i.bi.bi-eye.me-1
                          查看内容
                - else
                  .no-scripts
                    %i.bi.bi-file-text
                    %h3 暂无脚本
                    %p 创建您的第一个脚本开始使用
                    %button.btn.btn-primary{"data-bs-toggle" => "modal", "data-bs-target" => "#createScriptModal"}
                      %i.bi.bi-plus-lg.me-1
                      新建脚本

    .modal.fade#createScriptModal{:tabindex => "-1"}
      .modal-dialog
        .modal-content
          .modal-header
            %h5.modal-title 新建脚本
            %button.btn-close{"data-bs-dismiss" => "modal", :type => "button"}
          .modal-body
            %form{:action => "/scripts", :method => "post"}
              .mb-3
                %label.form-label 脚本名称 *
                %input.form-control{:type => "text", :name => "name", :required => "required", :placeholder => "例如: 部署脚本"}
              .mb-3
                %label.form-label 类型
                %select.form-select{:name => "script_type"}
                  %option{:value => ""} 选择脚本类型
                  %option{:value => "shell"} Shell
                  %option{:value => "python"} Python
                  %option{:value => "powershell"} PowerShell
                  %option{:value => "batch"} Batch
              .mb-3
                %label.form-label 描述
                %textarea.form-control{:name => "description", :rows => "3", :placeholder => "简要描述脚本功能"}
              .mb-3
                %label.form-label 脚本内容
                %textarea.form-control{:name => "content", :rows => "10", :placeholder => "# 在这里输入您的脚本内容\n"}
              .d-grid
                %button.btn.btn-primary{:type => "submit"}
                  %i.bi.bi-plus-lg.me-1
                  创建脚本

    %script{:src => "https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"}
    :javascript
      document.addEventListener('DOMContentLoaded', function() {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const mainContent = document.querySelector('.main-content');
        const header = document.querySelector('.header');
        
        // 侧边栏切换
        sidebarToggle.addEventListener('click', function() {
          sidebar.classList.toggle('collapsed');
          if (sidebar.classList.contains('collapsed')) {
            mainContent.style.marginLeft = '60px';
            header.style.left = '60px';
            sidebarToggle.innerHTML = '<i class="bi bi-list"></i>';
          } else {
            mainContent.style.marginLeft = '240px';
            header.style.left = '240px';
            sidebarToggle.innerHTML = '<i class="bi bi-list"></i>';
          }
        });
        
        // 删除脚本确认
        document.querySelectorAll('.delete-script').forEach(function(button) {
          button.addEventListener('click', function(e) {
            e.preventDefault();
            const scriptId = this.getAttribute('data-script-id');
            if (confirm('确定要删除这个脚本吗？此操作不可恢复。')) {
              // 发送删除请求
              fetch('/scripts/' + scriptId, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  'X-Requested-With': 'XMLHttpRequest'
                }
              })
              .then(response => {
                // 检查响应是否为JSON格式
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                  return response.json();
                } else {
                  // 如果不是JSON，返回一个成功的默认响应
                  return { success: true, message: '脚本删除成功' };
                }
              })
              .then(data => {
                if (data.success) {
                  alert('脚本删除成功');
                  location.reload();
                } else {
                  alert('删除失败: ' + (data.error || '未知错误'));
                }
              })
              .catch(error => {
                console.error('Error:', error);
                alert('删除失败: ' + error.message);
              });
            }
          });
        });
        
        // 搜索功能
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        
        function performSearch() {
          const searchTerm = searchInput.value.toLowerCase();
          const scriptCards = document.querySelectorAll('.script-card');
          
          scriptCards.forEach(function(card) {
            const scriptName = card.querySelector('.script-name').textContent.toLowerCase();
            const scriptDesc = card.querySelector('.script-description').textContent.toLowerCase();
            
            if (scriptName.includes(searchTerm) || scriptDesc.includes(searchTerm)) {
              card.style.display = 'block';
            } else {
              card.style.display = 'none';
            }
          });
        }
        
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', function(e) {
          if (e.key === 'Enter') {
            performSearch();
          }
        });
      });